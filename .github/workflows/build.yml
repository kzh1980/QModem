name: Build luci-app-qmodem-mwan using coolsnowwolf/lede

on:
  # 允许你手动在 Actions 页面点击 "Run workflow" 来触发
  workflow_dispatch:

jobs:
  build:
    # 在最新的 Ubuntu 系统上运行
    runs-on: ubuntu-latest

    steps:
    # 第 1 步：安装编译所必须的各种工具
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync unzip zlib1g-dev xz-utils

    # 第 2 步：下载 coolsnowwolf/lede 的源代码作为编译环境
    - name: Checkout coolsnowwolf/lede source
      run: |
        git clone https://github.com/coolsnowwolf/lede.git openwrt
        cd openwrt

    # 第 3 步：下载你自己的 QModem 仓库代码
    - name: Checkout QModem repository (your code)
      uses: actions/checkout@v4
      with:
        path: qmodem

    # 第 4 步：准备编译环境，并将你的插件代码复制进去
    - name: Prepare build environment
      run: |
        cd openwrt
        # 将你的插件代码复制到 lede 的 package 目录中
        mkdir -p package/luci-app-qmodem-mwan
        cp -r ../qmodem/luci/luci-app-qmodem-mwan/* package/luci-app-qmodem-mwan/
        
        # 更新 lede 的软件源并安装所有包
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成默认的编译配置文件
        make defconfig

    # 第 5 步：开始编译你的插件！
    - name: Compile the package
      run: |
        cd openwrt
        # -j1 表示单线程编译，可以避免一些潜在的错误
        make package/luci-app-qmodem-mwan/compile V=s -j1

    # 第 6 步：上传编译好的 .ipk 文件
    - name: Upload IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-qmodem-mwan-ipk-lede
        # 在 lede 的编译结果中，路径通常是这样的
        path: openwrt/bin/packages/x86_64/luci/luci-app-qmodem-mwan_*.ipk
