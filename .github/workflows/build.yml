name: Build luci-app-qmodem-mwan using OpenWrt SDK

on:
  # 允许你手动在 Actions 页面点击 "Run workflow" 来触发
  workflow_dispatch:

jobs:
  build:
    # 在最新的 Ubuntu 系统上运行
    runs-on: ubuntu-latest

    # 使用 OpenWrt 官方提供的、预装好所有依赖的 Docker 镜像作为编译环境
    container:
      image: openwrt/sdk
      # 以 root 用户身份运行容器内的所有步骤，解决权限问题
      options: --user root

    steps:
    # 第 1 步：下载你自己的 QModem 仓库代码
    - name: Checkout QModem repository (your code)
      uses: actions/checkout@v4
      with:
        path: qmodem

    # 第 2 步：准备编译环境
    - name: Prepare build environment
      # 指定此步骤在 SDK 的根目录中执行
      working-directory: /home/build/openwrt
      run: |
        # 将你的代码目录（使用绝对路径）链接为自定义软件源
        echo 'src-link qmodem ${{ github.workspace }}/qmodem/luci' >> feeds.conf.default
        
        # 更新并安装软件源
        ./scripts/feeds update -a
        ./scripts/feeds install -a -p qmodem
        
        # 生成默认的编译配置文件
        make defconfig

    # 第 3 步：开始编译你的插件！
    - name: Compile the package
      # 同样，指定此步骤在 SDK 的根目录中执行
      working-directory: /home/build/openwrt
      run: |
        # -j1 表示单线程编译，可以避免一些潜在的错误，也让日志更清晰
        make package/luci-app-qmodem-mwan/compile V=s -j1

    # 第 4 步：上传编译好的 .ipk 文件
    - name: Upload IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-qmodem-mwan-ipk-sdk
        path: /home/build/openwrt/bin/packages/x86_64/luci/luci-app-qmodem-mwan_*.ipk
